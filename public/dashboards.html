<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - NBFO</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    .admin-nav-btn {
        padding: 12px; border: none; border-radius: 6px; background: white;
        text-align: left; cursor: pointer; transition: 0.2s; font-weight: 500; color: #555;
    }
    .admin-nav-btn:hover { background: #eef2f7; }
    .admin-nav-btn.active { background: var(--admin); color: white; }
    .admin-table { width: 100%; border-collapse: collapse; background: white; }
    .admin-table th, .admin-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
</style>
</head>
<body>

<nav class="admin-sidebar" style="width: 220px; display: flex; flex-direction: column; gap: 10px;">
    <h3 style="font-size: 14px; color: var(--admin); text-transform: uppercase;">Configuration</h3>
    <button class="admin-nav-btn active" onclick="loadAdminSection('magasins', event)"><i class="fa-solid fa-shop"></i> Magasins</button>
    <button class="admin-nav-btn" onclick="loadAdminSection('users', event)"><i class="fa-solid fa-users-gear"></i> Utilisateurs</button>
    <button class="admin-nav-btn" onclick="loadAdminSection('employers', event)"><i class="fa-solid fa-id-badge"></i> Employ√©s</button>
    <button class="admin-nav-btn" onclick="loadAdminSection('producteurs', event)"><i class="fa-solid fa-wheat-awn"></i> Producteurs</button>
    <button class="admin-nav-btn" onclick="loadAdminSection('lots', event)"><i class="fa-solid fa-tags"></i> R√©f√©rentiel Lots</button>
    <button class="admin-nav-btn" onclick="loadAdminSection('validations', event)"><i class="fa-solid fa-tags"></i> Validations</button>

    <hr style="width:100%; border:0; border-top:1px solid #ddd;">
    <button class="btn-back" onclick="closeModule()">‚Üê Quitter</button>
</nav>
<script src="js/ui-utils.js"></script>
<script src="js/app.js"></script>
    <script src="js/common.js"></script>
<script>
/* administration.js consolid√© ‚Äî coller apr√®s ui-utils.js et juste avant </body> */
console.log('loadReference', typeof window.loadReference);
console.log('showAdminForm', typeof window.showAdminForm);
console.log('loadAdminSection', typeof window.loadAdminSection);
console.log('refreshAdminTable', typeof window.refreshAdminTable);
console.log('fetchCascade', typeof window.fetchCascade);

// helper fetch
async function safeFetchJson(url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
    return res.json();
}

// wrapper qui utilise loadReference si pr√©sent, sinon fallback
async function fillSelectFromApi(type, targetId, parentId = null, labelFn = null) {
    const target = document.getElementById(targetId);
    if (!target) return;
    if (typeof window.loadReference === 'function') {
        // loadReference g√®re d√©j√† le targetId et labelFn
        return window.loadReference(type, targetId, parentId, labelFn);
    }
    // fallback
    let url = `/api/${type}`;
    if (parentId) url += `?parent_id=${parentId}`;
    target.innerHTML = `<option value="">Chargement...</option>`;
    try {
        const data = await safeFetchJson(url);
        if (!Array.isArray(data) || data.length === 0) {
            target.innerHTML = `<option value="">‚ö†Ô∏è Aucun ${type} trouv√©</option>`;
            return;
        }
        target.innerHTML = `<option value="">-- S√©lectionner --</option>` +
            data.map(item => {
                const label = labelFn ? labelFn(item) : (item.nom || item.description || item.username || item.id);
                return `<option value="${item.id}">${label}</option>`;
            }).join('');
        target.disabled = false;
    } catch (err) {
        console.error(`Erreur chargement ${type}:`, err);
        target.innerHTML = `<option value="">‚ùå Erreur de chargement</option>`;
    }
}

// suppression d'un √©l√©ment
async function deleteItem(section, id) {
    if (!confirm('Confirmer la suppression ?')) return;
    try {
        const res = await fetch(`/api/${section}/${id}`, { method: 'DELETE' });
        if (!res.ok) throw new Error(`Suppression √©chou√©e (${res.status})`);
        await refreshAdminTable();
    } catch (err) {
        console.error('Erreur suppression:', err);
        alert('Impossible de supprimer : ' + (err.message || 'erreur'));
    }
}

/* --- Core admin logic --- */
let currentSection = 'magasins';

async function loadAdminSection(section, e) {
    currentSection = section;
    document.querySelectorAll('.admin-nav-btn').forEach(b => b.classList.remove('active'));
    if (e && e.currentTarget) e.currentTarget.classList.add('active');
    else {
        const btn = Array.from(document.querySelectorAll('.admin-nav-btn'))
            .find(b => (b.dataset.section === section) || (b.getAttribute('onclick') || '').includes(`loadAdminSection('${section}'`));
        if (btn) btn.classList.add('active');
    }
    const titleEl = document.getElementById('admin-title');
    if (titleEl) titleEl.innerText = section.charAt(0).toUpperCase() + section.slice(1);
    await refreshAdminTable();
}

async function refreshAdminTable() {
    const wrapper = document.getElementById('admin-table-wrapper');
    if (!wrapper) return;
    wrapper.innerHTML = "Chargement...";

    let endpoint;
    let errorMessage;
    switch (currentSection) {
        case 'magasins': endpoint = '/api/magasins'; errorMessage = 'Impossible de charger la liste des magasins.'; break;
        case 'users': case 'utilisateurs': endpoint = '/api/users'; errorMessage = 'Impossible de charger la liste des utilisateurs.'; break;
        case 'employers': case 'employes': endpoint = '/api/employers'; errorMessage = 'Impossible de charger la liste des employ√©s.'; break;
        case 'producteurs': endpoint = '/api/producteurs'; errorMessage = 'Impossible de charger la liste des producteurs.'; break;
        case 'lots': endpoint = '/api/lots'; errorMessage = 'Impossible de charger le r√©f√©rentiel des lots.'; break;
        case 'validations': endpoint = '/api/validations'; errorMessage = 'Impossible de charger les validations en attente.'; break;
        default:
            wrapper.innerHTML = `<p style='color:orange; padding:20px;'>‚ö†Ô∏è Section "${currentSection}" non reconnue.</p>`;
            console.error(`Section admin inconnue : ${currentSection}`);
            return;
    }

    try {
        const res = await fetch(endpoint);
        if (!res.ok) {
            if (res.status === 404) throw new Error(`Endpoint ${endpoint} introuvable (404)`);
            if (res.status === 403) throw new Error(`Acc√®s refus√© (403). Droits insuffisants.`);
            throw new Error(`Erreur HTTP ${res.status}`);
        }
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error('Format de donn√©es invalide (tableau attendu)');
        renderAdminTable(data);
    } catch (err) {
        console.error('Erreur refreshAdminTable:', err);
        wrapper.innerHTML = `
            <div style='background:#ffebee; padding:20px; border-radius:8px; border-left:4px solid #d32f2f;'>
                <h4 style='color:#c62828; margin-top:0;'>${errorMessage}</h4>
                <p style='color:#555; font-size:14px; margin:10px 0;'><strong>D√©tails :</strong> ${err.message}</p>
                <button class="btn" onclick="refreshAdminTable()" style="background:#d32f2f; color:white; margin-top:10px;">R√©essayer</button>
            </div>
        `;
        if (typeof logDeploymentError === 'function') logDeploymentError(`Admin-Load-${currentSection}`, err);
    }
}

function renderAdminTable(data) {
    const wrapper = document.getElementById('admin-table-wrapper');
    if (!data || data.length === 0) {
        wrapper.innerHTML = "Aucune donn√©e trouv√©e.";
        return;
    }

    const exclude = new Set(['password_hash','password','created_at','last_login']);
    const headers = Object.keys(data[0]).filter(h => !exclude.has(h));

    let html = `<table class="admin-table"><thead><tr>`;
    headers.forEach(h => html += `<th>${h.replace(/_/g,' ')}</th>`);
    html += `<th>Actions</th></tr></thead><tbody>`;

    data.forEach(row => {
        html += `<tr>`;
        headers.forEach(h => {
            let val = row[h];
            if (val === null || val === undefined) val = '';
            html += `<td>${String(val)}</td>`;
        });
        html += `<td><button onclick="deleteItem('${currentSection}', ${row.id})">üóëÔ∏è</button></td></tr>`;
    });

    html += `</tbody></table>`;
    wrapper.innerHTML = html;
}

/* --- Form display and forms handling --- */
function showAdminForm() {
    const wrapper = document.getElementById('admin-table-wrapper');
    if (!wrapper) return;

    // LOTS
    if (currentSection === 'lots') {
        wrapper.innerHTML = `...`; // tu peux r√©ins√©rer ton template lots ici
        return;
    }

    // USERS
    if (currentSection === 'users' || currentSection === 'utilisateurs') {
        wrapper.innerHTML = `
            <form id="form-user" style="background:white; padding:20px; border-radius:8px; max-width:900px;">
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px;">
                    <div class="form-group"><label>Pr√©nom</label><input type="text" id="user-prenom" required></div>
                    <div class="form-group"><label>Nom</label><input type="text" id="user-nom" required></div>
                    <div class="form-group"><label>Nom d'utilisateur</label><input type="text" id="user-username" required></div>
                    <div class="form-group"><label>Mot de passe</label><input type="password" id="user-password" required></div>
                    <div class="form-group"><label>R√¥le</label>
                        <select id="user-role" required>
                            <option value="">-- Choisir un r√¥le --</option>
                            <option value="superadmin">superadmin</option>
                            <option value="admin">admin</option>
                            <option value="auditeur">auditeur</option>
                            <option value="caisse">caisse</option>
                            <option value="stock">stock</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Email</label><input type="email" id="user-email"></div>
                    <div class="form-group"><label>T√©l√©phone</label><input type="tel" id="user-telephone"></div>
                    <div class="form-group"><label>Magasin d'affectation</label>
                        <select id="user-magasin-select"><option value="">-- Choisir un magasin --</option></select>
                    </div>
                    <div class="form-group"><label>Statut</label>
                        <select id="user-statut"><option value="actif">actif</option><option value="inactif">inactif</option></select>
                    </div>
                    <div style="grid-column: 1 / -1; display:flex; justify-content:flex-end; gap:10px; margin-top:12px;">
                        <button type="button" class="btn" onclick="refreshAdminTable()">Annuler</button>
                        <button type="submit" class="btn" style="background:var(--admin); color:white;">Cr√©er l'utilisateur</button>
                    </div>
                </div>
            </form>
        `;
        fillSelectFromApi('magasins', 'user-magasin-select', null, m => `${m.nom}${m.code ? ' ('+m.code+')' : ''}`);

        const form = document.getElementById('form-user');
        const onSubmit = async (ev) => {
            ev.preventDefault();
            const payload = {
                username: document.getElementById('user-username').value.trim(),
                password: document.getElementById('user-password').value,
                role: document.getElementById('user-role').value,
                prenom: document.getElementById('user-prenom').value.trim(),
                nom: document.getElementById('user-nom').value.trim(),
                email: document.getElementById('user-email').value.trim() || null,
                telephone: document.getElementById('user-telephone').value.trim() || null,
                magasin_id: document.getElementById('user-magasin-select').value || null,
                statut: document.getElementById('user-statut').value || 'actif'
            };
            try {
                const res = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) {
                    const errText = await res.text().catch(()=>null);
                    throw new Error(errText || `Erreur HTTP ${res.status}`);
                }
                form.removeEventListener('submit', onSubmit);
                await refreshAdminTable();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (err) {
                console.error('Erreur cr√©ation utilisateur:', err);
                alert('Impossible de cr√©er l‚Äôutilisateur : ' + (err.message || 'erreur inconnue'));
            }
        };
        form.addEventListener('submit', onSubmit);
        return;
    }

    // EMPLOYERS
    if (currentSection === 'employers' || currentSection === 'employes') {
        wrapper.innerHTML = `...`; // ins√®re ici le template employ√© complet si tu veux
        return;
    }

    // MAGASINS
    if (currentSection === 'magasins') {
        wrapper.innerHTML = `...`; // ins√®re ici le template magasin complet si tu veux
        return;
    }

    // PRODUCTEURS
    if (currentSection === 'producteurs') {
        wrapper.innerHTML = `
            <form id="form-admin-dynamic" style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                <input type="text" name="nom" placeholder="Nom complet" required>
                <input type="tel" name="tel" placeholder="T√©l√©phone">
                <select id="reg-select" onchange="fetchCascade('departements', this.value, 'dep-select')">
                    <option value="">-- S√©lectionner R√©gion --</option>
                </select>
                <select id="dep-select" disabled onchange="fetchCascade('arrondissements', this.value, 'arr-select')">
                    <option value="">-- Attente R√©gion --</option>
                </select>
                <select id="arr-select" disabled><option value="">-- Attente D√©partement --</option></select>
                <div style="grid-column: 1 / -1; display:flex; gap:10px; margin-top:20px;">
                    <button type="submit" class="btn" style="background:var(--admin); color:white;">Enregistrer</button>
                    <button type="button" onclick="refreshAdminTable()">Annuler</button>
                </div>
            </form>
        `;
        fetchCascade('regions', null, 'reg-select');
        return;
    }

    // default
    wrapper.innerHTML = `<p>Formulaire pour ${currentSection} en d√©veloppement.</p>`;
}

// cascade
async function fetchCascade(type, parentId, targetId) {
    const target = document.getElementById(targetId);
    if (!target) return;
    let url = `/api/${type}`;
    if (parentId) url += `?parent_id=${parentId}`;
    target.innerHTML = `<option value="">Chargement...</option>`;
    try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        target.innerHTML = `<option value="">-- S√©lectionner --</option>`;
        data.forEach(item => {
            const label = item.nom || item.name || item.libelle || item.id;
            target.add(new Option(label, item.id));
        });
        target.disabled = false;
    } catch (err) {
        console.error("Erreur cascade:", err);
        target.innerHTML = `<option value="">‚ùå Erreur de chargement</option>`;
    }
}

/* --- DOM ready : attacher listeners --- */
document.addEventListener('DOMContentLoaded', () => {
    // nav buttons : prefer data-section if present, else fallback to onclick parsing
    document.querySelectorAll('.admin-nav-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const section = btn.dataset.section || (btn.getAttribute('onclick') || '').match(/loadAdminSection\('([^']+)'/)?.[1];
            if (section) loadAdminSection(section, e);
        });
    });

    const btnAdd = document.getElementById('btn-add-admin');
    if (btnAdd) btnAdd.addEventListener('click', () => {
        if (typeof showAdminForm === 'function') showAdminForm();
        else console.error('showAdminForm non d√©fini');
    });

    // initial load
    if (typeof refreshAdminTable === 'function') refreshAdminTable();
});
</script>
</body>
</html>
