<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion des Stocks</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .header {
      background: white;
      border-radius: 15px;
      padding: 20px 30px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo {
      font-size: 40px;
    }

    .header-title h1 {
      color: #333;
      font-size: 24px;
      margin-bottom: 5px;
    }

    .header-title p {
      color: #666;
      font-size: 14px;
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    .btn-dashboard, .btn-logout {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }

    .btn-dashboard {
      background: #667eea;
      color: white;
    }

    .btn-logout {
      background: #f56565;
      color: white;
    }

    .btn-dashboard:hover {
      background: #5568d3;
    }

    .btn-logout:hover {
      background: #e53e3e;
    }

    .nav-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .nav-tab {
      background: white;
      padding: 12px 25px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 500;
      color: #555;
    }

    .nav-tab:hover {
      background: #f0f0f0;
    }

    .nav-tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .container {
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .card {
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .card-header {
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }

    .card-title {
      font-size: 20px;
      font-weight: 600;
      color: #333;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-weight: 500;
      margin-bottom: 8px;
      color: #555;
    }

    .form-group input,
    .form-group select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    .form-group select[multiple] {
      min-height: 120px;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
    }

    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #d0d0d0;
    }

    .btn-success {
      background: #48bb78;
      color: white;
    }

    .btn-success:hover {
      background: #38a169;
    }

    .btn-warning {
      background: #ed8936;
      color: white;
    }

    .btn-warning:hover {
      background: #dd6b20;
    }

    #criteriaList {
      list-style: none;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 6px;
      min-height: 100px;
    }

    #criteriaList li {
      padding: 8px;
      background: white;
      margin-bottom: 5px;
      border-radius: 4px;
      border-left: 3px solid #667eea;
    }

    .table-container {
      overflow-x: auto;
      margin: 20px 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    table th,
    table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }

    table th {
      background: #f5f5f5;
      font-weight: 600;
      color: #333;
    }

    table tbody tr:hover {
      background: #f9f9f9;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-entree {
      background: #c6f6d5;
      color: #22543d;
    }

    .badge-sortie {
      background: #fed7d7;
      color: #742a2a;
    }

    .btn-icon {
      padding: 6px 12px;
      font-size: 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .alert.success {
      background: #c6f6d5;
      color: #22543d;
      border-left: 4px solid #48bb78;
    }

    .alert.error {
      background: #fed7d7;
      color: #742a2a;
      border-left: 4px solid #f56565;
    }

    .alert.show {
      display: block;
    }

    #lotsList {
      list-style: none;
      margin-top: 20px;
    }

    #lotsList li {
      padding: 10px;
      background: #f9f9f9;
      margin-bottom: 8px;
      border-radius: 6px;
      border-left: 3px solid #667eea;
    }
  </style>
</head>
<body>
  <div id="alertContainer"></div>

  <div class="header">
    <div class="header-left">
      <div class="logo">üì¶</div>
      <div class="header-title">
        <h1>Gestion des Stocks</h1>
        <p>Administration et suivi des lots</p>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn-dashboard">üè† Tableau de bord</button>
      <button class="btn-logout">D√©connexion</button>
    </div>
  </div>

  <div class="nav-tabs">
    <div class="nav-tab active" data-tab="definition">D√©finition des lots</div>
    <div class="nav-tab" data-tab="admission">Admission des lots</div>
    <div class="nav-tab" data-tab="retraits">Retraits</div>
    <div class="nav-tab" data-tab="transfer">Transferts</div>
  </div>

  <div class="container">
    <!-- ONGLET : D√©finition des lots -->
<div id="definition" class="tab-content active">
  <div class="card">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
      <div class="card-title">Gestion des lots</div>
      <button id="toggleLotForm" class="btn btn-primary">Ôºã Nouveau Lot</button>
    </div>

    <div id="lotFormContainer" style="display: none; padding: 20px; border-bottom: 2px solid #eee; background: #fdfdfd;">
      <form id="newLotForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="categorieLot">Cat√©gorie *</label>
            <select id="categorieLot" required>
              <option value="">S√©lectionner</option>
              <option value="frais">Produits frais</option>
              <option value="court">Cycle court</option>
              <option value="secs">Produits secs</option>
              <option value="manualim">Manufactur√©s alimentaires</option>
              <option value="nonalim">Manufactur√©s non alimentaires</option>
              <option value="sensible">Produits sensibles</option>
            </select>
          </div>
          <div class="form-group">
            <label for="description">Description *</label>
            <input type="text" id="description" required>
          </div>
          <div class="form-group">
            <label for="prixRef">Prix de r√©f√©rence *</label>
            <input type="number" id="prixRef" required min="0" step="0.01">
          </div>
          <div class="form-group">
            <label>Unit√©s admises *</label>
            <div id="unitesCheckboxes" class="checkbox-group">
              <label><input type="checkbox" name="unite_lot" value="kg"> Kilogrammes</label>
              <label><input type="checkbox" name="unite_lot" value="g"> Grammes</label>
              <label><input type="checkbox" name="unite_lot" value="L"> Litres</label>
              <label><input type="checkbox" name="unite_lot" value="unite"> Unit√©s</label>
              <label><input type="checkbox" name="unite_lot" value="sac"> Sacs</label>
              <label><input type="checkbox" name="unite_lot" value="caisse"> Caisses</label>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label>Crit√®res d'admission</label>
          <ul id="criteriaList"></ul>
          <button type="button" id="addCriteriaBtn" class="btn btn-secondary" style="margin-top:10px;">‚ûï Nouveau crit√®re</button>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Enregistrer le lot</button>
          <button type="button" id="cancelLotForm" class="btn btn-secondary">Annuler</button>
        </div>
      </form>
    </div>

    <div id="lotsListContainer" style="padding: 20px;">
      <h4>Lots enregistr√©s</h4>
      <table class="table" style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="text-align: left; border-bottom: 2px solid #eee;">
            <th>Description</th>
            <th>Cat√©gorie</th>
            <th>Prix R√©f.</th>
            <th>Stock</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tbodyLots">
          </tbody>
      </table>
    </div>
  </div>
</div>

    <!-- ONGLET 2: Admission des lots -->
    <div id="admission" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Admission des lots</div>
        </div>
        <form id="admissionForm">
          <div class="form-grid">
            <div class="form-group">
              <label for="lotSelect">Produit / Lot *</label>
              <select id="lotSelect" required></select>
            </div>
            <div class="form-group">
              <label for="quantity">Quantit√© *</label>
              <input type="number" id="quantity" min="0" step="0.01" required>
            </div>

            <div class="form-group">
    <label>Unit√© de mesure *</label>
    <div id="unitesAdmissionContainer" required class="checkbox-group">
        <em>S√©lectionnez un lot puis continuez</em>
    </div>
</div>            
            <div class="form-group">
              <label for="price">Prix (unit√©) *</label>
              <input type="number" id="price" step="0.01" required>
            </div>
            <div class="form-group">
              <label for="qualityCoeff">Coefficient qualit√© *</label>
              <select id="qualityCoeff" required>
                <option value="">S√©lectionner</option>
                <option value="A">A - Excellente (1)</option>
                <option value="B">B - Bonne (0.9)</option>
                <option value="C">C - Moyenne (0.85)</option>
                <option value="D">D - Faible (0.7)</option>
              </select>
            </div>
            <div class="form-group">
              <label for="producerSelect">D√©posant *</label>
              <select id="producerSelect" required></select>
            </div>
            <div class="form-group">
              <label for="expirationDate">Date d'expiration</label>
              <input type="date" id="expirationDate">
            </div>
            <div class="form-group">
              <label for="magasinSelect">Magasin *</label>
              <select id="magasinSelect" required></select>
            </div>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">‚ûï Enregistrer l'admission</button>
          </div>
        </form>
      </div>

      <!-- Liste des admissions -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Admissions r√©centes</div>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Lot</th>
                <th>Producteur</th>
                <th>Quantit√©</th>
                <th>Prix</th>
                <th>Qualit√©</th>
              </tr>
            </thead>
            <tbody id="admissionsList"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ONGLET 3: Retraits -->
    <div id="retraits" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Retraits de stock</div>
        </div>
        <button id="newRetraitBtn" class="btn btn-primary">‚ûï Nouveau retrait</button>
        
        <form id="retraitForm" style="display:none; margin-top:20px;">
          <div class="form-grid">
            <div class="form-group">
              <label for="retraitLot">Lot *</label>
              <select id="retraitLot" required></select>
            </div>
            <div class="form-group">
              <label for="typeRetrait">Type de retrait *</label>
              <select id="typeRetrait" required>
                <option value="vente">Vente client</option>
                <option value="producteur">Retour producteur</option>
                <option value="magasin">Transfert magasin</option>
                <option value="destruction">Destruction</option>
              </select>
            </div>
            <div class="form-group">
              <label for="retraitQuantity">Quantit√© *</label>
              <input type="number" id="retraitQuantity" min="0" step="0.01" required>
            </div>
            <div class="form-group">
              <label for="retraitUnite">Unit√© *</label>
              <select id="retraitUnite" required></select>
            </div>
            <div class="form-group" id="destProducteurGroup" style="display:none;">
              <label for="destProducteur">Producteur destinataire</label>
              <select id="destProducteur"></select>
            </div>
            <div class="form-group" id="destMagasinGroup" style="display:none;">
              <label for="destMagasinRetrait">Magasin destinataire</label>
              <select id="destMagasinRetrait"></select>
            </div>
            <div class="form-group" id="motifGroup" style="display:none;">
              <label for="motif">Motif</label>
              <input type="text" id="motif">
            </div>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-success">‚úÖ Enregistrer</button>
            <button type="button" class="btn btn-secondary" id="cancelRetraitBtn">Annuler</button>
          </div>
        </form>

        <div class="table-container" style="margin-top:20px;">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Lot</th>
                <th>Type</th>
                <th>Quantit√©</th>
                <th>Destination</th>
              </tr>
            </thead>
            <tbody id="retraitsList"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ONGLET 4: Transferts -->
    <div id="transfer" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Transferts inter-magasins</div>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Lot</th>
                <th>Quantit√©</th>
                <th>Magasin destinataire</th>
                <th>Utilisateur</th>
              </tr>
            </thead>
            <tbody id="transferList"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script src = "/js/common.js"></script>
  <script>
    const routes = {
    lotss: '/api/lots',
    admissions: '/api/admissions', // Corrig√© selon ton router
    producteurs: '/api/producteurs'
};
   // ============ CONFIGURATION ============
    const API_BASE = '/api';
    let CURRENT_USER = 'admin';
    let CURRENT_MAGASIN_ID = 1;

    const defaultCriteria = {
      frais: ["Fra√Æcheur", "Calibre minimum", "Absence de pesticides", "Pr√©sentation propre"],
      court: ["Date r√©cente", "Dur√©e ‚â§ 7 jours", "Cha√Æne de froid", "Emballage adapt√©"],
      secs: ["Humidit√© ‚â§ 12%", "Absence de moisissures", "Uniformit√© du tri", "Odeur normale"],
      manualim: ["Conformit√© hygi√®ne", "Date fabrication & p√©remption", "Emballage conforme", "Certification interne"],
      nonalim: ["Finition correcte", "Solidit√©", "Esth√©tique", "Tra√ßabilit√©"],
      sensible: ["Stockage contr√¥l√©", "Tra√ßabilit√© stricte", "Emballage s√©curis√©", "Autorisation r√©glementaire"]
    };

    // ============ UTILITAIRES ============
    function showAlert(message, type = 'success') {
      const container = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert ${type} show`;
      alert.textContent = message;
      container.appendChild(alert);
      setTimeout(() => alert.remove(), 3000);
    }

    // ============ GESTION DES ONGLETS (Plac√©e en haut pour priorit√©) ============
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
        tab.classList.add('active');
        const target = document.getElementById(tab.dataset.tab);
        if (target) target.classList.add('active');
      });
    });

    // ============ FONCTIONS DE CHARGEMENT ============
    // 1. Gestion du Masquage/D√©masquage
const toggleBtn = document.getElementById('toggleLotForm');
const formContainer = document.getElementById('lotFormContainer');
const cancelBtn = document.getElementById('cancelLotForm');

toggleBtn.addEventListener('click', () => {
    formContainer.style.display = 'block';
    toggleBtn.style.display = 'none'; // Cache le bouton "Nouveau" pendant l'√©dition
});

cancelBtn.addEventListener('click', () => {
    formContainer.style.display = 'none';
    toggleBtn.style.display = 'block';
    document.getElementById('newLotForm').reset();
    document.getElementById('criteriaList').innerHTML = '';
});

// 2. Mise √† jour de loadLots pour remplir la table ET les selects
async function loadLots() {
    try {
        const response = await fetch(`${API_BASE}/lots`);
        const lots = await response.json();
        
        // Remplissage du tableau r√©capitulatif
        const tbody = document.getElementById('tbodyLots');
        if (Array.isArray(lots)) {
            tbody.innerHTML = lots.map(l => `
                <tr style="border-bottom: 1px solid #eee;">
                    <td><strong>${l.description}</strong></td>
                    <td>${l.categorie}</td>
                    <td>${l.prix_ref}</td>
                    <td>${l.stock_disponible || 0}</td>
                    <td>
                        <button onclick="deleteLot(${l.id})" class="btn btn-danger" style="padding: 2px 8px; font-size: 12px;">Supprimer</button>
                    </td>
                </tr>
            `).join('');
            
           // Remplissage des selects des autres onglets (Admission / Retrait)
const lotSelects = document.querySelectorAll('#lotSelect, #retraitLot');

// Modification ici : on ajoute l'attribut data-unites qui contient le tableau JSON
const options = '<option value="">S√©lectionner un lot</option>' + 
    lots.map(l => {
        // On transforme le tableau d'unit√©s en cha√Æne de caract√®res s√©curis√©e
        const unitesJSON = JSON.stringify(l.unites_admises || []);
        return `<option value="${l.id}" data-unites='${unitesJSON}'>${l.description}</option>`;
    }).join('');

lotSelects.forEach(select => {
    if (select) select.innerHTML = options;
});
        }
    } catch (err) {
        console.error('Erreur chargement lots:', err);
    }
}
    // √âcouteur pour mettre √† jour les unit√©s quand on choisit un lot dans l'onglet Admission
document.getElementById('lotSelect').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const containerUnites = document.getElementById('unitesAdmissionContainer'); 
    
    // Si on a choisi un lot (id non vide)
    if (selectedOption.value && selectedOption.getAttribute('data-unites')) {
        try {
            const unites = JSON.parse(selectedOption.getAttribute('data-unites'));
            
            // On cr√©e des boutons radio pour forcer l'utilisateur √† choisir une unit√© valide
            containerUnites.innerHTML = '<label style="display:block; margin-bottom:5px;">Unit√© pour cette admission :</label>' + 
                unites.map(u => `
                    <label style="margin-right:15px; cursor:pointer;">
                        <input type="radio" name="unite_admission" value="${u}" required> ${u}
                    </label>
                `).join('');
        } catch (e) {
            console.error("Erreur de lecture des unit√©s", e);
            containerUnites.innerHTML = "‚ö†Ô∏è Erreur format unit√©s";
        }
    } else {
        containerUnites.innerHTML = "<em>S√©lectionnez d'abord un lot pour voir les unit√©s</em>";
    }
});

    async function loadProducers() {
      try {
        const response = await fetch(`${API_BASE}/producteurs`);
        const producers = await response.json();
        const options = '<option value="">S√©lectionner un producteur</option>' +
          producers.map(p => `<option value="${p.id}">${p.nom_producteur}</option>`).join('');
        document.getElementById('producerSelect').innerHTML = options;
        document.getElementById('destProducteur').innerHTML = options;
      } catch (err) { console.error(err); }
    }

    async function loadMagasins() {
      try {
        const response = await fetch(`${API_BASE}/magasins`);
        const magasins = await response.json();
        const options = '<option value="">S√©lectionner un magasin</option>' +
          magasins.map(m => `<option value="${m.id}">${m.nom}</option>`).join('');
        document.getElementById('magasinSelect').innerHTML = options;
        document.getElementById('destMagasinRetrait').innerHTML = options;
      } catch (err) { console.error(err); }
    }

    // ============ √âV√âNEMENTS FORMULAIRES ============
    document.getElementById('categorieLot').addEventListener('change', function() {
      const cat = this.value;
      const list = document.getElementById('criteriaList');
      list.innerHTML = "";
      if (defaultCriteria[cat]) {
        defaultCriteria[cat].forEach(c => {
          const li = document.createElement('li');
          li.textContent = c;
          list.appendChild(li);
        });
        document.getElementById('addCriteriaBtn').style.display = 'inline-block';
      }
    });

    document.getElementById('typeRetrait').addEventListener('change', function() {
      const type = this.value;
      document.getElementById('destProducteurGroup').style.display = type === 'producteur' ? 'block' : 'none';
      document.getElementById('destMagasinGroup').style.display = type === 'magasin' ? 'block' : 'none';
      document.getElementById('motifGroup').style.display = type === 'destruction' ? 'block' : 'none';
    });

// ============ FORMULAIRE : CR√âATION DE LOT ============
    document.getElementById('newLotForm').addEventListener('submit', async (e) => {
      e.preventDefault();
  // 1. R√©cup√©rer le bouton et le d√©sactiver
    const btn = e.target.querySelector('button[type="submit"]');
    btn.disabled = true;
    btn.innerText = "Cr√©ation en cours...";
  // stocks.html
const body = {
    categorie: document.getElementById('categorieLot').value,
    description: document.getElementById('description').value.trim(),
    prix_ref: parseFloat(document.getElementById('prixRef').value) || 0,
    // On s'assure d'envoyer des tableaux simples
    unites_admises: Array.from(document.querySelectorAll('input[name="unite_lot"]:checked')).map(cb => cb.value),
    criteres_admission: Array.from(document.querySelectorAll('#criteriaList li')).map(li => li.innerText.trim()),
    stock_disponible: 0
};

// Loguez le body dans votre console pour v√©rifier avant l'envoi
console.log("Donn√©es envoy√©es :", body);

const response = await fetch(`${API_BASE}/lots`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
});

      
  try {
  const response = await fetch(`${API_BASE}/lots`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(body) // C'est ici que l'objet est cr√©√© pour le serveur
  });

  const result = await response.json(); // On r√©cup√®re la r√©ponse pour voir les erreurs √©ventuelles

  if (!response.ok) {
    // Si Ajv renvoie une erreur, on l'affiche pr√©cis√©ment
    console.error('Erreurs de validation:', result.errors);
    throw new Error(result.message || 'Erreur lors de la cr√©ation');
  }

  showAlert("Lot cr√©√© avec succ√®s ‚úÖ");
  // 1. Vider les champs texte et reset le menu d√©roulant
    document.getElementById('lotForm').reset(); 
    // On masque le formulaire et on r√©affiche le bouton "Nouveau"
    formContainer.style.display = 'none';
    toggleBtn.style.display = 'block';
    // 2. Vider la liste dynamique des crit√®res (le UL)
    document.getElementById('criteriaList').innerHTML = ''; 
    
    // 3. Rafra√Æchir les listes d√©roulantes pour voir le nouveau lot imm√©diatement
    await loadLots();
} catch (err) {
  console.error('Erreur:', err);
  showAlert(err.message, "error");
}
      finally {
        // 4. R√©activer le bouton quoi qu'il arrive
        btn.disabled = false;
        btn.innerText = "Cr√©er le lot";
    }
    });

    // ============ FORMULAIRE : ADMISSION EN STOCK ============
    // Gestion de la soumission du formulaire d'admission
document.getElementById('admissionForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const btn = e.target.querySelector('button[type="submit"]');
    if (btn.disabled) return;

    // R√©cup√©ration de l'unit√© s√©lectionn√©e (le bouton radio dynamique)
    const selectedUnite = e.target.querySelector('input[name="unite_admission"]:checked');
    
    if (!selectedUnite) {
        showAlert("Veuillez s√©lectionner une unit√© de mesure", "error");
        return;
    }

    const body = {
        lot_id: document.getElementById('lotSelect').value,
        quantite: parseFloat(document.getElementById('quantity').value),
        unite: selectedUnite.value,
        prix_unitaire: parseFloat(document.getElementById('price').value),
        qualite: document.getElementById('qualityCoeff').value,
        producteur_id: document.getElementById('producerSelect').value,
        magasin_id: document.getElementById('magasinSelect').value,
        date_expiration: document.getElementById('expirationDate').value || null
    };

    btn.disabled = true;
    btn.innerText = "Enregistrement...";

    try {
        const response = await fetch(`${API_BASE}/admissions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });

        if (response.ok) {
            showAlert("Admission enregistr√©e avec succ√®s ‚úÖ");
            e.target.reset();
            document.getElementById('unitesAdmissionContainer').innerHTML = "<em>S√©lectionnez d'abord un lot</em>";                      
          // 1. R√©initialiser le formulaire (vide les inputs quantity, price, etc.)
    const form = document.getElementById('admissionForm');
    form.reset(); 

    // 2. Vider le conteneur dynamique des unit√©s
    // On remet le message d'attente pour forcer l'utilisateur √† re-choisir un lot
    const unitesContainer = document.getElementById('unitesAdmissionContainer');
    if (unitesContainer) {
        unitesContainer.innerHTML = '<em>S√©lectionnez d'abord un lot</em>';
    }

    // 3. Rafra√Æchir les donn√©es
    // On recharge les lots pour mettre √† jour les stocks affich√©s partout
    await loadLots(); 
    
    // Si vous avez une fonction pour la liste des admissions en bas de page
    if (typeof loadAdmissions === 'function') {
        await loadAdmissions();
    }
}
        } else {
            const errData = await response.json();
            throw new Error(errData.message || "Erreur lors de l'admission");
        }
    } catch (err) {
        console.error('Erreur Admission:', err);
        showAlert(err.message, "error");
    } finally {
        btn.disabled = false;
        btn.innerText = "‚ûï Enregistrer l'admission";
    }
});

    // ============ FORMULAIRE : RETRAIT DE STOCK ============
    document.getElementById('retraitForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const type_retrait = document.getElementById('typeRetrait').value;
      const body = {
        lot_id: parseInt(document.getElementById('retraitLot').value),
        quantite: parseFloat(document.getElementById('retraitQuantity').value),
        unite: document.getElementById('retraitUnite').value,
        type_retrait: type_retrait,
        utilisateur: CURRENT_USER,
        magasin_id: CURRENT_MAGASIN_ID
      };

      // Ajout des champs conditionnels
      if (type_retrait === 'producteur') body.destination_producteur_id = parseInt(document.getElementById('destProducteur').value);
      if (type_retrait === 'magasin') body.destination_magasin_id = parseInt(document.getElementById('destMagasinRetrait').value);
      if (type_retrait === 'destruction') body.motif = document.getElementById('motif').value;

      try {
        const response = await fetch(`${API_BASE}/retraits`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        if (!response.ok) throw new Error("Erreur retrait");

        showAlert("Retrait valid√© ‚úÖ");
        document.getElementById('retraitForm').reset();
        document.getElementById('retraitForm').style.display = 'none';
        loadLots();
      } catch (err) {
        showAlert("Erreur lors du retrait ‚ùå", "error");
      }
    });

    // Gestion de l'affichage dynamique des unit√©s selon le lot choisi
   function updateUnits(unites) {
    const container = document.getElementById('unitesAdmissionContainer');
    // S√©curit√© pour √©viter le crash "null"
    if (!container) {
        console.warn("Le conteneur 'unitesAdmissionContainer' n'est pas encore pr√™t.");
        return; 
    }

    if (!unites || unites.length === 0) {
        container.innerHTML = "<em>Aucune unit√© d√©finie pour ce lot</em>";
        return;
    }

    container.innerHTML = unites.map(u => `
        <label style="margin-right:10px;">
            <input type="radio" name="unite_admission" value="${u}" required> ${u}
        </label>
    `).join('');
}
    
    document.getElementById('lotSelect').addEventListener('change', () => updateUnits('lotSelect', 'unitSelect'));
    document.getElementById('retraitLot').addEventListener('change', () => updateUnits('retraitLot', 'retraitUnite'));

    document.getElementById('newRetraitBtn').addEventListener('click', () => {
      document.getElementById('retraitForm').style.display = 'block';
    });

    document.getElementById('cancelRetraitBtn').addEventListener('click', () => {
      document.getElementById('retraitForm').style.display = 'none';
    });

    // ============ AFFICHAGE : LISTE DES ADMISSIONS ============
    async function loadAdmissions() {
      try {
        const response = await fetch(`${API_BASE}/admissions`);
        if (!response.ok) return;
        const admissions = await response.json();
        
        const tbody = document.getElementById('admissionsList');
        // On affiche les 10 derni√®res admissions
        tbody.innerHTML = admissions.slice().reverse().slice(0, 10).map(a => `
          <tr>
            <td>${new Date(a.date_reception).toLocaleDateString()}</td>
            <td>${a.lot_description || 'N/A'}</td>
            <td>${a.nom_producteur || 'N/A'}</td>
            <td>${a.quantite} ${a.unite}</td>
            <td>${a.prix_ref} FCFA</td>
            <td><span class="badge badge-entree">${a.coef_qualite || 'B'}</span></td>
          </tr>
        `).join('');
      } catch (err) {
        console.error('Erreur chargement admissions:', err);
      }
    }

    // ============ AFFICHAGE : LISTE DES RETRAITS ============
    async function loadRetraits() {
      try {
        const response = await fetch(`${API_BASE}/retraits`);
        if (!response.ok) return;
        const retraits = await response.json();
        
        const tbody = document.getElementById('retraitsList');
        tbody.innerHTML = retraits.slice().reverse().slice(0, 10).map(r => `
          <tr>
            <td>${new Date(r.date_retrait || Date.now()).toLocaleDateString()}</td>
            <td>${r.lot_description || 'N/A'}</td>
            <td><span class="badge ${r.type_retrait === 'vente' ? 'badge-entree' : 'badge-sortie'}">${r.type_retrait}</span></td>
            <td>${r.quantite} ${r.unite}</td>
            <td>${r.destination_producteur_id ? 'Retour Prod.' : r.destination_magasin_id ? 'Transfert' : 'Client'}</td>
          </tr>
        `).join('');
      } catch (err) {
        console.error('Erreur chargement retraits:', err);
      }
    }

    async function deleteLot(id) {
    // Confirmation avant suppression
    if (!confirm("Voulez-vous vraiment supprimer ce lot ? Cette action est irr√©versible.")) {
        return;
    }

    try {
        const response = await fetch(`${API_BASE}/lots/${id}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            // Succ√®s : on informe l'utilisateur et on recharge les donn√©es
            showAlert("Lot supprim√© avec succ√®s !");
            await loadLots(); // Met √† jour le tableau et les menus Admission/Retrait
        } else {
            const result = await response.json();
            // Si le lot est li√© √† une admission existante, la base de donn√©es bloquera la suppression
            alert(result.message || "Erreur lors de la suppression. Le lot est peut-√™tre utilis√© ailleurs.");
        }
    } catch (err) {
        console.error("Erreur lors de l'appel DELETE:", err);
        alert("Impossible de joindre le serveur pour la suppression.");
    }
}
    
    // ============ MISE √Ä JOUR DE L'INITIALISATION ============
    // Modifiez votre bloc DOMContentLoaded pour inclure ces appels
    document.addEventListener("DOMContentLoaded", () => {
      loadLots();
      loadProducers();
      loadMagasins();
      loadAdmissions();
      loadRetraits();
    });
  </script>
</body>
</html>
