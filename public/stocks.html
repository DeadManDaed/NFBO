<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion des Stocks</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .header {
      background: white;
      border-radius: 15px;
      padding: 20px 30px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo {
      font-size: 40px;
    }

    .header-title h1 {
      color: #333;
      font-size: 24px;
      margin-bottom: 5px;
    }

    .header-title p {
      color: #666;
      font-size: 14px;
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    .btn-dashboard, .btn-logout {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }

    .btn-dashboard {
      background: #667eea;
      color: white;
    }

    .btn-logout {
      background: #f56565;
      color: white;
    }

    .btn-dashboard:hover {
      background: #5568d3;
    }

    .btn-logout:hover {
      background: #e53e3e;
    }

    .nav-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .nav-tab {
      background: white;
      padding: 12px 25px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 500;
      color: #555;
    }

    .nav-tab:hover {
      background: #f0f0f0;
    }

    .nav-tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .container {
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .card {
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .card-header {
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }

    .card-title {
      font-size: 20px;
      font-weight: 600;
      color: #333;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-weight: 500;
      margin-bottom: 8px;
      color: #555;
    }

    .form-group input,
    .form-group select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    .form-group select[multiple] {
      min-height: 120px;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
    }

    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #d0d0d0;
    }

    .btn-success {
      background: #48bb78;
      color: white;
    }

    .btn-success:hover {
      background: #38a169;
    }

    .btn-warning {
      background: #ed8936;
      color: white;
    }

    .btn-warning:hover {
      background: #dd6b20;
    }

    #criteriaList {
      list-style: none;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 6px;
      min-height: 100px;
    }

    #criteriaList li {
      padding: 8px;
      background: white;
      margin-bottom: 5px;
      border-radius: 4px;
      border-left: 3px solid #667eea;
    }

    .table-container {
      overflow-x: auto;
      margin: 20px 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    table th,
    table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }

    table th {
      background: #f5f5f5;
      font-weight: 600;
      color: #333;
    }

    table tbody tr:hover {
      background: #f9f9f9;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-entree {
      background: #c6f6d5;
      color: #22543d;
    }

    .badge-sortie {
      background: #fed7d7;
      color: #742a2a;
    }

    .btn-icon {
      padding: 6px 12px;
      font-size: 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .alert.success {
      background: #c6f6d5;
      color: #22543d;
      border-left: 4px solid #48bb78;
    }

    .alert.error {
      background: #fed7d7;
      color: #742a2a;
      border-left: 4px solid #f56565;
    }

    .alert.show {
      display: block;
    }

    #lotsList {
      list-style: none;
      margin-top: 20px;
    }

    #lotsList li {
      padding: 10px;
      background: #f9f9f9;
      margin-bottom: 8px;
      border-radius: 6px;
      border-left: 3px solid #667eea;
    }
  </style>
</head>
<body>
  <div id="alertContainer"></div>

  <div class="header">
    <div class="header-left">
      <div class="logo">üì¶</div>
      <div class="header-title">
        <h1>Gestion des Stocks</h1>
        <p>Administration et suivi des lots</p>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn-dashboard">üè† Tableau de bord</button>
      <button class="btn-logout">D√©connexion</button>
    </div>
  </div>

  <div class="nav-tabs">
    <div class="nav-tab active" data-tab="definition">D√©finition des lots</div>
    <div class="nav-tab" data-tab="admission">Admission des lots</div>
    <div class="nav-tab" data-tab="retraits">Retraits</div>
    <div class="nav-tab" data-tab="transfer">Transferts</div>
  </div>

  <div class="container">
    <!-- ONGLET 1: D√©finition des lots -->
    <div id="definition" class="tab-content active">
      <div class="card">
        <div class="card-header">
          <div class="card-title">D√©finition des lots</div>
        </div>
        <form id="newLotForm">
          <div class="form-grid">
            <div class="form-group">
              <label for="categorieLot">Cat√©gorie *</label>
              <select id="categorieLot" required>
                <option value="">S√©lectionner</option>
                <option value="frais">Produits frais</option>
                <option value="court">Cycle court</option>
                <option value="secs">Produits secs</option>
                <option value="manualim">Manufactur√©s alimentaires</option>
                <option value="nonalim">Manufactur√©s non alimentaires</option>
                <option value="sensible">Produits sensibles</option>
              </select>
            </div>
            <div class="form-group">
              <label for="description">Description *</label>
              <input type="text" id="description" required>
            </div>
            <div class="form-group">
              <label for="prixRef">Prix de r√©f√©rence *</label>
              <input type="number" id="prixRef" required min="0" step="0.01">
            </div>
            <div class="form-group">
              <label for="unitesLot">Unit√©s admises *</label>
              <select id="unitesLot" multiple required>
                <option value="kg">Kilogrammes</option>
                <option value="g">Grammes</option>
                <option value="L">Litres</option>
                <option value="unite">Unit√©s</option>
                <option value="sac">Sacs</option>
                <option value="caisse">Caisses</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Crit√®res d'admission</label>
            <ul id="criteriaList"></ul>
            <button type="button" id="addCriteriaBtn" class="btn btn-secondary" style="display:none; margin-top:10px;">‚ûï Nouveau crit√®re</button>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Cr√©er le lot</button>
          </div>
        </form>
        <ul id="lotsList"></ul>
      </div>
    </div>

    <!-- ONGLET 2: Admission des lots -->
    <div id="admission" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Admission des lots</div>
        </div>
        <form id="admissionForm">
          <div class="form-grid">
            <div class="form-group">
              <label for="lotSelect">Produit / Lot *</label>
              <select id="lotSelect" required></select>
            </div>
            <div class="form-group">
              <label for="quantity">Quantit√© *</label>
              <input type="number" id="quantity" min="0" step="0.01" required>
            </div>
            <div class="form-group">
              <label for="unitSelect">Unit√© *</label>
              <select id="unitSelect" required></select>
            </div>
            <div class="form-group">
              <label for="price">Prix (unit√©) *</label>
              <input type="number" id="price" step="0.01" required>
            </div>
            <div class="form-group">
              <label for="qualityCoeff">Coefficient qualit√© *</label>
              <select id="qualityCoeff" required>
                <option value="">S√©lectionner</option>
                <option value="A">A - Excellente (1.2)</option>
                <option value="B">B - Bonne (1.0)</option>
                <option value="C">C - Moyenne (0.8)</option>
                <option value="D">D - Faible (0.6)</option>
              </select>
            </div>
            <div class="form-group">
              <label for="producerSelect">D√©posant *</label>
              <select id="producerSelect" required></select>
            </div>
            <div class="form-group">
              <label for="expirationDate">Date d'expiration</label>
              <input type="date" id="expirationDate">
            </div>
            <div class="form-group">
              <label for="magasinSelect">Magasin *</label>
              <select id="magasinSelect" required></select>
            </div>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">‚ûï Enregistrer l'admission</button>
          </div>
        </form>
      </div>

      <!-- Liste des admissions -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Admissions r√©centes</div>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Lot</th>
                <th>Producteur</th>
                <th>Quantit√©</th>
                <th>Prix</th>
                <th>Qualit√©</th>
              </tr>
            </thead>
            <tbody id="admissionsList"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ONGLET 3: Retraits -->
    <div id="retraits" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Retraits de stock</div>
        </div>
        <button id="newRetraitBtn" class="btn btn-primary">‚ûï Nouveau retrait</button>
        
        <form id="retraitForm" style="display:none; margin-top:20px;">
          <div class="form-grid">
            <div class="form-group">
              <label for="retraitLot">Lot *</label>
              <select id="retraitLot" required></select>
            </div>
            <div class="form-group">
              <label for="typeRetrait">Type de retrait *</label>
              <select id="typeRetrait" required>
                <option value="vente">Vente client</option>
                <option value="producteur">Retour producteur</option>
                <option value="magasin">Transfert magasin</option>
                <option value="destruction">Destruction</option>
              </select>
            </div>
            <div class="form-group">
              <label for="retraitQuantity">Quantit√© *</label>
              <input type="number" id="retraitQuantity" min="0" step="0.01" required>
            </div>
            <div class="form-group">
              <label for="retraitUnite">Unit√© *</label>
              <select id="retraitUnite" required></select>
            </div>
            <div class="form-group" id="destProducteurGroup" style="display:none;">
              <label for="destProducteur">Producteur destinataire</label>
              <select id="destProducteur"></select>
            </div>
            <div class="form-group" id="destMagasinGroup" style="display:none;">
              <label for="destMagasinRetrait">Magasin destinataire</label>
              <select id="destMagasinRetrait"></select>
            </div>
            <div class="form-group" id="motifGroup" style="display:none;">
              <label for="motif">Motif</label>
              <input type="text" id="motif">
            </div>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-success">‚úÖ Enregistrer</button>
            <button type="button" class="btn btn-secondary" id="cancelRetraitBtn">Annuler</button>
          </div>
        </form>

        <div class="table-container" style="margin-top:20px;">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Lot</th>
                <th>Type</th>
                <th>Quantit√©</th>
                <th>Destination</th>
              </tr>
            </thead>
            <tbody id="retraitsList"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ONGLET 4: Transferts -->
    <div id="transfer" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Transferts inter-magasins</div>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Lot</th>
                <th>Quantit√©</th>
                <th>Magasin destinataire</th>
                <th>Utilisateur</th>
              </tr>
            </thead>
            <tbody id="transferList"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script src = "/js/common.js"></script>
  <script>
    // ============ CONFIGURATION ============
    const API_BASE = '/api';
    let CURRENT_USER = 'admin'; // √Ä remplacer par la session
    let CURRENT_MAGASIN_ID = 1; // √Ä remplacer par la session

    // ============ UTILITAIRES ============
    function showAlert(message, type = 'success') {
      const container = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert ${type} show`;
      alert.textContent = message;
      container.appendChild(alert);
      setTimeout(() => {
        alert.remove();
      }, 3000);
    }

    // ============ CRIT√àRES PAR CAT√âGORIE ============
    const defaultCriteria = {
      frais: ["Fra√Æcheur", "Calibre minimum", "Absence de pesticides", "Pr√©sentation propre"],
      court: ["Date r√©cente", "Dur√©e ‚â§ 7 jours", "Cha√Æne de froid", "Emballage adapt√©"],
      secs: ["Humidit√© ‚â§ 12%", "Absence de moisissures", "Uniformit√© du tri", "Odeur normale"],
      manualim: ["Conformit√© hygi√®ne", "Date fabrication & p√©remption", "Emballage conforme", "Certification interne"],
      nonalim: ["Finition correcte", "Solidit√©", "Esth√©tique", "Tra√ßabilit√©"],
      sensible: ["Stockage contr√¥l√©", "Tra√ßabilit√© stricte", "Emballage s√©curis√©", "Autorisation r√©glementaire"]
    };

    function loadCriteria() {
      const cat = document.getElementById('categorieLot').value;
      const list = document.getElementById('criteriaList');
      list.innerHTML = "";
      if (defaultCriteria[cat]) {
        defaultCriteria[cat].forEach(c => {
          const li = document.createElement('li');
          li.textContent = c;
          list.appendChild(li);
        });
        document.getElementById('addCriteriaBtn').style.display = 'inline-block';
      }
    }

    document.getElementById('categorieLot').addEventListener('change', loadCriteria);

    document.getElementById('addCriteriaBtn').addEventListener('click', () => {
      const newCritere = prompt("Entrez un nouveau crit√®re d'admission :");
      if (newCritere && newCritere.trim() !== "") {
        const li = document.createElement('li');
        li.textContent = newCritere.trim();
        document.getElementById('criteriaList').appendChild(li);
      }
    });

    // ============ GESTION DES ONGLETS ============
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
      });
    });

    // ============ CHARGEMENT DES DONN√âES ============
    async function loadLots() {
      try {
        const response = await fetch(`${API_BASE}/admissions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            lot_id, producteur_id, quantite, unite, prix_ref,
            date_reception, date_expiration, magasin_id, 
            utilisateur: CURRENT_USER,
            coef_qualite
          })
        });

        if (response.ok) {
          showAlert('Admission enregistr√©e ‚úÖ', 'success');
          document.getElementById('admissionForm').reset();
          loadAdmissions();
          loadLots(); // Rafra√Æchir pour mettre √† jour les stocks
        } else {
          throw new Error('Erreur API');
        }
      } catch (err) {
        console.error(err);
        showAlert('Erreur lors de l'enregistrement ‚ùå', 'error');
      }
    });

    // ============ FORMULAIRE RETRAIT ============
    document.getElementById('typeRetrait').addEventListener('change', function() {
      const type = this.value;
      document.getElementById('destProducteurGroup').style.display = type === 'producteur' ? 'block' : 'none';
      document.getElementById('destMagasinGroup').style.display = type === 'magasin' ? 'block' : 'none';
      document.getElementById('motifGroup').style.display = type === 'destruction' ? 'block' : 'none';
    });

    document.getElementById('newRetraitBtn').addEventListener('click', () => {
      document.getElementById('retraitForm').style.display = 'block';
    });

    document.getElementById('cancelRetraitBtn').addEventListener('click', () => {
      document.getElementById('retraitForm').style.display = 'none';
      document.getElementById('retraitForm').reset();
    });

    document.getElementById('retraitForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const lot_id = parseInt(document.getElementById('retraitLot').value);
      const quantite = parseFloat(document.getElementById('retraitQuantity').value);
      const unite = document.getElementById('retraitUnite').value;
      const type_retrait = document.getElementById('typeRetrait').value;
      
      const body = {
        lot_id,
        quantite,
        unite,
        type_retrait,
        utilisateur: CURRENT_USER,
        magasin_id: CURRENT_MAGASIN_ID,
        prix_ref: 0 // Sera calcul√© c√¥t√© serveur si n√©cessaire
      };

      if (type_retrait === 'producteur') {
        body.destination_producteur_id = parseInt(document.getElementById('destProducteur').value);
      } else if (type_retrait === 'magasin') {
        body.destination_magasin_id = parseInt(document.getElementById('destMagasinRetrait').value);
      } else if (type_retrait === 'destruction') {
        body.motif = document.getElementById('motif').value;
      }

      try {
        const response = await fetch(`${API_BASE}/retraits`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        if (response.ok) {
          showAlert('Retrait enregistr√© ‚úÖ', 'success');
          document.getElementById('retraitForm').reset();
          document.getElementById('retraitForm').style.display = 'none';
          loadRetraits();
          loadLots(); // Rafra√Æchir pour mettre √† jour les stocks
        } else {
          throw new Error('Erreur API');
        }
      } catch (err) {
        console.error(err);
        showAlert('Erreur lors du retrait ‚ùå', 'error');
      }
    });

    // ============ INITIALISATION ============
    document.addEventListener("DOMContentLoaded", () => {
      loadLots();
      loadProducers();
      loadMagasins();
      loadAdmissions();
      loadRetraits();
    });
response = await fetch(`${API_BASE}/lots`);
        const lots = await response.json();
        
        // Pour le formulaire d'admission
        const select = document.getElementById('lotSelect');
        select.innerHTML = '<option value="">S√©lectionner un lot</option>' +
          lots.map(l => `<option value="${l.id}" data-unites='${JSON.stringify(l.unites_admises)}' data-prix="${l.prix_ref}">${l.description} (${l.categorie})</option>`).join('');
        
        // Pour le formulaire de retrait
        const retraitSelect = document.getElementById('retraitLot');
        retraitSelect.innerHTML = '<option value="">S√©lectionner un lot</option>' +
          lots.map(l => `<option value="${l.id}" data-unites='${JSON.stringify(l.unites_admises)}'>${l.description} - Stock: ${l.stock_disponible}</option>`).join('');
      } catch (err) {
        console.error('Erreur chargement lots:', err);
      }
    }

    async function loadProducers() {
      try {
        const response = await fetch(`${API_BASE}/producteurs`);
        const producers = await response.json();
        
        const select = document.getElementById('producerSelect');
        select.innerHTML = '<option value="">S√©lectionner un producteur</option>' +
          producers.map(p => `<option value="${p.id}">${p.nom_producteur} - ${p.tel_producteur || ''}</option>`).join('');
        
        const destSelect = document.getElementById('destProducteur');
        destSelect.innerHTML = '<option value="">S√©lectionner</option>' + select.innerHTML;
      } catch (err) {
        console.error('Erreur chargement producteurs:', err);
      }
    }

    async function loadMagasins() {
      try {
        const response = await fetch(`${API_BASE}/magasins`);
        const magasins = await response.json();
        
        const select = document.getElementById('magasinSelect');
        select.innerHTML = '<option value="">S√©lectionner un magasin</option>' +
          magasins.map(m => `<option value="${m.id}">${m.nom}</option>`).join('');
        
        const destSelect = document.getElementById('destMagasinRetrait');
        destSelect.innerHTML = '<option value="">S√©lectionner</option>' + select.innerHTML;
      } catch (err) {
        console.error('Erreur chargement magasins:', err);
      }
    }

    async function loadAdmissions() {
      try {
        const response = await fetch(`${API_BASE}/admissions`);
        const admissions = await response.json();
        
        const tbody = document.getElementById('admissionsList');
        tbody.innerHTML = admissions.slice(0, 10).map(a => `
          <tr>
            <td>${new Date(a.date_reception).toLocaleDateString()}</td>
            <td>${a.lot_description || 'N/A'}</td>
            <td>${a.nom_producteur || 'N/A'}</td>
            <td>${a.quantite} ${a.unite}</td>
            <td>${a.prix_ref} FCFA</td>
            <td>${a.coef_qualite || 'N/A'}</td>
          </tr>
        `).join('');
      } catch (err) {
        console.error('Erreur chargement admissions:', err);
      }
    }

    async function loadRetraits() {
      try {
        const response = await fetch(`${API_BASE}/retraits`);
        const retraits = await response.json();
        
        const tbody = document.getElementById('retraitsList');
        tbody.innerHTML = retraits.slice(0, 10).map(r => `
          <tr>
            <td>${new Date(r.date_retrait || Date.now()).toLocaleDateString()}</td>
            <td>${r.lot_description || 'N/A'}</td>
            <td>${r.type_retrait}</td>
            <td>${r.quantite} ${r.unite}</td>
            <td>${r.destination_producteur_id ? r.nom_producteur : r.destination_magasin_id ? 'Magasin' : 'Client'}</td>
          </tr>
        `).join('');
      } catch (err) {
        console.error('Erreur chargement retraits:', err);
      }
    }

    function loadUnitsForLot(selectId, targetId) {
      const selectLot = document.getElementById(selectId);
      const selectedOption = selectLot.options[selectLot.selectedIndex];
      const unites = JSON.parse(selectedOption.getAttribute('data-unites') || '[]');
      const unitSelect = document.getElementById(targetId);
      unitSelect.innerHTML = unites.map(u => `<option value="${u}">${u}</option>`).join('');
      
      // Charger le prix de r√©f√©rence si disponible
      if (selectId === 'lotSelect') {
        const prixRef = selectedOption.getAttribute('data-prix');
        if (prixRef) {
          document.getElementById('price').value = prixRef;
        }
      }
    }

    document.getElementById('lotSelect').addEventListener('change', function() {
      loadUnitsForLot('lotSelect', 'unitSelect');
    });

    document.getElementById('retraitLot').addEventListener('change', function() {
      loadUnitsForLot('retraitLot', 'retraitUnite');
    });

    // ============ FORMULAIRE D√âFINITION LOT ============
    document.getElementById('newLotForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const categorie = document.getElementById('categorieLot').value;
      const description = document.getElementById('description').value;
      const prix_ref = parseFloat(document.getElementById('prixRef').value);
      
      const unitesSelect = document.getElementById('unitesLot');
      const unites_admises = Array.from(unitesSelect.selectedOptions).map(opt => opt.value);
      
      const criteres = Array.from(document.querySelectorAll('#criteriaList li')).map(li => li.textContent);

      try {
        const response = await fetch(`${API_BASE}/lots`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            categorie, 
            description, 
            prix_ref, 
            unites_admises,
            criteres_admission: criteres,
            stock_disponible: 0
          })
        });

        if (!response.ok) throw new Error("Erreur API lots");

        const newLot = await response.json();
        showAlert("Lot cr√©√© ‚úÖ", 'success');

        const list = document.getElementById('lotsList');
        const li = document.createElement('li');
        li.textContent = `${newLot.description} (${newLot.categorie}) - Prix r√©f: ${newLot.prix_ref} FCFA`;
        list.appendChild(li);

        document.getElementById('newLotForm').reset();
        document.getElementById('criteriaList').innerHTML = "";
        document.getElementById('addCriteriaBtn').style.display = 'none';
        
        loadLots();
      } catch (err) {
        console.error(err);
        showAlert("Impossible de cr√©er le lot ‚ùå", 'error');
      }
    });

    // ============ FORMULAIRE ADMISSION ============
    document.getElementById('admissionForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const lot_id = parseInt(document.getElementById('lotSelect').value);
      const quantite = parseFloat(document.getElementById('quantity').value);
      const unite = document.getElementById('unitSelect').value;
      const prix_ref = parseFloat(document.getElementById('price').value);
      const coef_qualite = document.getElementById('qualityCoeff').value;
      const producteur_id = parseInt(document.getElementById('producerSelect').value);
      const date_expiration = document.getElementById('expirationDate').value || null;
      const magasin_id = parseInt(document.getElementById('magasinSelect').value);

      const date_reception = new Date().toISOString().split('T')[0];

      try {
        const response = await fetch(`${API_BASE}/admissions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            lot_id, 
            producteur_id, 
            quantite, 
            unite, 
            prix_ref,
            date_reception, 
            date_expiration, 
            magasin_id, 
            utilisateur: CURRENT_USER,
            coef_qualite
          })
        });

        if (response.ok) {
          showAlert('Admission enregistr√©e ‚úÖ', 'success');
          document.getElementById('admissionForm').reset();
          loadAdmissions();
          loadLots(); // Rafra√Æchir pour mettre √† jour les stocks
        } else {
          throw new Error('Erreur API');
        }
      } catch (err) {
        console.error(err);
        showAlert('Erreur lors de l'enregistrement ‚ùå', 'error');
      }
    });

    // ============ FORMULAIRE RETRAIT ============
    document.getElementById('typeRetrait').addEventListener('change', function() {
      const type = this.value;
      document.getElementById('destProducteurGroup').style.display = type === 'producteur' ? 'block' : 'none';
      document.getElementById('destMagasinGroup').style.display = type === 'magasin' ? 'block' : 'none';
      document.getElementById('motifGroup').style.display = type === 'destruction' ? 'block' : 'none';
    });

    document.getElementById('newRetraitBtn').addEventListener('click', () => {
      document.getElementById('retraitForm').style.display = 'block';
    });

    document.getElementById('cancelRetraitBtn').addEventListener('click', () => {
      document.getElementById('retraitForm').style.display = 'none';
      document.getElementById('retraitForm').reset();
    });

    document.getElementById('retraitForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const lot_id = parseInt(document.getElementById('retraitLot').value);
      const quantite = parseFloat(document.getElementById('retraitQuantity').value);
      const unite = document.getElementById('retraitUnite').value;
      const type_retrait = document.getElementById('typeRetrait').value;
      
      const body = {
        lot_id,
        quantite,
        unite,
        type_retrait,
        utilisateur: CURRENT_USER,
        magasin_id: CURRENT_MAGASIN_ID,
        prix_ref: 0 // Sera calcul√© c√¥t√© serveur si n√©cessaire
      };

      if (type_retrait === 'producteur') {
        body.destination_producteur_id = parseInt(document.getElementById('destProducteur').value);
      } else if (type_retrait === 'magasin') {
        body.destination_magasin_id = parseInt(document.getElementById('destMagasinRetrait').value);
      } else if (type_retrait === 'destruction') {
        body.motif = document.getElementById('motif').value;
      }

      try {
        const response = await fetch(`${API_BASE}/retraits`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        if (response.ok) {
          showAlert('Retrait enregistr√© ‚úÖ', 'success');
          document.getElementById('retraitForm').reset();
          document.getElementById('retraitForm').style.display = 'none';
          loadRetraits();
          loadLots(); // Rafra√Æchir pour mettre √† jour les stocks
        } else {
          throw new Error('Erreur API');
        }
      } catch (err) {
        console.error(err);
        showAlert('Erreur lors du retrait ‚ùå', 'error');
      }
    });

    // ============ INITIALISATION ============
    document.addEventListener("DOMContentLoaded", () => {
      loadLots();
      loadProducers();
      loadMagasins();
      loadAdmissions();
      loadRetraits();
    });
  </script>
</body>
</html>
