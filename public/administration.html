<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administration - NBFO Coopérative</title>
<style>
    /* Bloc CSS global */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: #f5f5f5; color: #333; }

    /* Header */
    .header { background: linear-gradient(135deg, #1976d2, #42a5f5); color: white; padding: 20px 40px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
    .header-left { display: flex; align-items: center; gap: 20px; }
    .logo { width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; }
    .header-title h1 { font-size: 24px; margin-bottom: 5px; }
    .header-title p { font-size: 14px; opacity: 0.9; }
    .header-actions { display: flex; gap: 15px; align-items: center; }
    .btn-dashboard { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; gap: 8px; }
    .btn-dashboard:hover { background: rgba(255,255,255,0.3); }
    .btn-logout { background: rgba(244, 67, 54, 0.8); border: none; color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; }
    /* Navigation tabs */
    .nav-tabs { background: white; padding: 0 40px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; gap: 5px; overflow-x: auto; }
    .nav-tab { padding: 18px 25px; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; font-weight: 600; color: #666; white-space: nowrap; display: flex; align-items: center; gap: 8px; }
    .nav-tab:hover { color: #1976d2; background: #f9f9f9; }
    .nav-tab.active { color: #1976d2; border-bottom-color: #1976d2; background: #f9f9f9; }

    /* Container */
    .container { max-width: 1400px; margin: 0 auto; padding: 30px 40px; }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Cards */
    .card { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0; }
    .card-title { font-size: 22px; font-weight: 700; color: #1976d2; display: flex; align-items: center; gap: 10px; }

    /* Form styles */
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .form-group { display: flex; flex-direction: column; }
    label { font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px; }
    input, select, textarea { padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: all 0.3s; font-family: inherit; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #1976d2; box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1); }
    /* Buttons */
    .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
    .btn-primary { background: linear-gradient(135deg, #1976d2, #42a5f5); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(25, 118, 210, 0.3); }
    .btn-secondary { background: #f5f5f5; color: #666; }
    .btn-secondary:hover { background: #e0e0e0; }
    .btn-success { background: linear-gradient(135deg, #43a047, #388e3c); color: white; }
    .btn-danger { background: linear-gradient(135deg, #e53935, #d32f2f); color: white; }
    .btn-warning { background: linear-gradient(135deg, #fb8c00, #f57c00); color: white; }

    /* Table */
    .table-container { overflow-x: auto; margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; }
    th { background: #f9f9f9; padding: 15px; text-align: left; font-weight: 600; color: #666; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
    td { padding: 15px; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
    tr:hover { background: #fafafa; }

    /* Badges */
    .badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .badge-entree { background: #e8f5e9; color: #388e3c; }
    .badge-sortie { background: #fff3e0; color: #f57c00; }
    .badge-disponible { background: #e3f2fd; color: #1976d2; }
    .badge-alerte { background: #ffebee; color: #d32f2f; }
    /* Alert messages */
    .alert { padding: 15px 20px; border-radius: 10px; margin-bottom: 20px; display: none; animation: slideDown 0.3s; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .alert-success { background: #e8f5e9; border: 1px solid #66bb6a; color: #2e7d32; }
    .alert-error { background: #ffebee; border: 1px solid #ef5350; color: #c62828; }
    .alert-warning { background: #fff3e0; border: 1px solid #ffa726; color: #f57c00; }

    /* Stats cards */
    .stats-row { display: grid; grid-template-columns: repeat(auto-fit    .alert-warning { background: #fff3e0; border: 1px solid #ffa726; color: #f57c00; }

    /* Stats cards */
    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: white; padding: 20px; border-radius: 12px; border-left: 4px solid #1976d2; }
    .stat-value { font-size: 32px; font-weight: 700; color: #1976d2; margin-bottom: 5px; }
    .stat-label { color: #666; font-size: 14px; }

    /* Loading spinner */
    .loading { text-align: center; padding: 40px; color: #999; }
    .loading-spinner { display: inline-block; width: 40px; height: 40px; border: 4px solid #f0f0f0; border-radius: 50%; border-top-color: #1976d2; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Action buttons in table */
    .action-btns { display: flex; gap: 8px; }
    .btn-icon { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
    .btn-icon:hover { transform: scale(1.1); }

    /* Responsive */
    @media (max-width: 968px) {
      .container { padding: 20px; }
      .header { padding: 15px 20px; flex-direction: column; gap: 15px; }
      .nav-tabs { padding: 0 20px; }
      .form-grid { grid-template-columns: 1fr; }
      .action-btns { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div id="adminProducteurs" class="tab-content">
  <div class="card">
    <div class="card-header">
      <div class="card-title">Ajouter un producteur</div>
    </div>

    <form id="producerForm" style="margin-top:20px;">
      <div class="form-grid">
        <!-- Nom -->
        <div class="form-group">
          <label for="nomProducteur">Nom du producteur *</label>
          <input type="text" id="nomProducteur" maxlength="100" required>
        </div>

        <!-- Téléphone -->
        <div class="form-group">
          <label for="telProducteur">Téléphone *</label>
          <input type="tel" id="telProducteur" maxlength="20" required>
        </div>

        <!-- Type producteur -->
        <div class="form-group">
          <label for="typeProducteur">Type *</label>
          <select id="typeProducteur" required>
            <option value="agriculteur">Agriculteur</option>
            <option value="éleveur">Éleveur</option>
            <option value="pêcheur">Pêcheur</option>
            <option value="artisan">Artisan</option>
            <option value="alimentaire manufacture">Alimentaire manufacture</option>
            <option value="coopérative">Coopérative</option>
            <option value="individuel">Individuel</option>
            <option value="autre">Autre</option>
          </select>
        </div>

        <!-- Carte membre -->
        <div class="form-group">
          <label for="carteMembre">Carte membre</label>
          <input type="checkbox" id="carteMembre">
        </div>

        <!-- Points fidélité -->
        <div class="form-group">
          <label for="pointsFidelite">Points fidélité</label>
          <input type="number" id="pointsFidelite" min="0" step="1" value="0">
        </div>

        <!-- Solde -->
        <div class="form-group">
          <label for="solde">Solde initial</label>
          <input type="number" id="solde" min="0" step="0.01" value="0">
        </div>

        <!-- Statut -->
        <div class="form-group">
          <label for="statut">Statut</label>
          <select id="statut">
            <option value="en_attente" selected>En attente</option>
            <option value="actif">Actif</option>
            <option value="suspendu">Suspendu</option>
          </select>
        </div>

        <!-- Région -->
        <div class="form-group">
          <label for="region">Région</label>
          <select id="region"></select>
        </div>

        <!-- Département -->
        <div class="form-group">
          <label for="departement">Département</label>
          <select id="departement"></select>
        </div>

        <!-- Arrondissement -->
        <div class="form-group">
          <label for="arrondissement">Arrondissement</label>
          <select id="arrondissement"></select>
        </div>

        <!-- Localité -->
        <div class="form-group">
          <label for="localite">Localité</label>
          <input type="text" id="localite" maxlength="100">
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-success">✅ Ajouter producteur</button>
      </div>
    </form>
  </div>
</div>

<script src="/js/auth.js"></script>
<script>   
  // Ce code reste tel quel - il ne touche PAS aux mots de passe
  function getCurrentUser() {
  const userInfo = sessionStorage.getItem("userInfo");
  return userInfo ? JSON.parse(userInfo) : null;
}

function requireLogin() {
  const user = getCurrentUser();
  if (!user || !user.username || !user.role) {
    sessionStorage.clear();
    window.location.href = "/index.html";
    return null;
  }
  return user;
}

/*function loadRoleContent(role) {
  
  
}*/

  // Charger régions/départements/arrondissements dynamiquement
async function loadGeo() {
  try {
    const regionsResp = await fetch('/api/regions');
    const regions = await regionsResp.json();
    document.getElementById('region').innerHTML =
      regions.map(r => `<option value="${r.id}">${r.nom}</option>`).join('');

    document.getElementById('region').addEventListener('change', async (e) => {
      const depResp = await fetch(`/api/departements?region_id=${e.target.value}`);
      const deps = await depResp.json();
      document.getElementById('departement').innerHTML =
        deps.map(d => `<option value="${d.id}">${d.nom}</option>`).join('');
    });

    document.getElementById('departement').addEventListener('change', async (e) => {
      const arrResp = await fetch(`/api/arrondissements?departement_id=${e.target.value}`);
      const arrs = await arrResp.json();
      document.getElementById('arrondissement').innerHTML =
        arrs.map(a => `<option value="${a.id}">${a.nom}</option>`).join('');
    });
  } catch (err) {
    console.error("Erreur chargement géo", err);
  }
}

// Soumission du formulaire
document.getElementById('producerForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const payload = {
    nom_producteur: document.getElementById('nomProducteur').value,
    tel_producteur: document.getElementById('telProducteur').value,
    type_producteur: document.getElementById('typeProducteur').value,
    carte_membre: document.getElementById('carteMembre').checked,
    points_fidelite: parseInt(document.getElementById('pointsFidelite').value),
    solde: parseFloat(document.getElementById('solde').value),
    statut: document.getElementById('statut').value,
    region_id: document.getElementById('region').value || null,
    departement_id: document.getElementById('departement').value || null,
    arrondissement_id: document.getElementById('arrondissement').value || null,
    localite: document.getElementById('localite').value
  };

  try {
    const response = await fetch('/api/producteurs', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!response.ok) throw new Error("Erreur API producteurs");

    alert("Producteur ajouté ✅");
    document.getElementById('producerForm').reset();
  } catch (err) {
    console.error(err);
    alert("Impossible d’ajouter le producteur ❌");
  }
});

// Charger géo au démarrage
loadGeo();

</script>
  <script defer>
    const alertBox=document.getElementById('alertBox');
    const usersContainer=document.getElementById('usersContainer');
          let currentUser=null;

    function showError(msg){
      alertBox.textContent=msg;
      alertBox.style.display='block';
    }

    try{
      const userInfo=sessionStorage.getItem('userInfo');
      if(!userInfo) window.location.href='/index.html';
      currentUser=JSON.parse(userInfo);
      if(currentUser.role!=='admin'||currentUser.role!=='superadmin'){
        showError('Accès refusé : réservé aux administrateurs');
        setTimeout(()=>window.location.href='/dashboard.html',2000);
      }
    }catch(err){
      showError('Session invalide, reconnectez-vous.');
      setTimeout(()=>window.location.href='/index.html',2000);
    }
    async function loadUsers(){
      try{
        const res=await fetch('/users');
        if(!res.ok) throw new Error();
        const users=await res.json();
        if(users.length===0){usersContainer.textContent='Aucun utilisateur';return;}
        usersContainer.innerHTML=`<table>
          <thead><tr><th>Nom</th><th>Rôle</th><th>Actions</th></tr></thead>
          <tbody>${users.map(u=>`
            <tr>
              <td>${u.username}</td>
              <td>${u.role}</td>
              <td>
                <button onclick="editUser('${u.id}')">Modifier</button>
                <button onclick="deleteUser('${u.id}')">Supprimer</button>
              </td>
            </tr>`).join('')}
          </tbody></table>`;
      }catch(err){
        usersContainer.textContent='Erreur de chargement';
      }
    }
    loadUsers();
    async function editUser(id){
      const newRole=prompt('Nouveau rôle pour cet utilisateur (admin, caisse, stock)');
      if(!newRole) return;
      try{
        const res=await fetch(`/users/${id}`,{
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({role:newRole})
        });
        if(res.ok){loadUsers();}else{showError('Erreur modification');}
      }catch(err){showError('Erreur réseau');}
    }

    async function deleteUser(id){
      if(!confirm('Supprimer cet utilisateur ?')) return;
      try{
        const res=await fetch(`/users/${id}`,{method:'DELETE'});
        if(res.ok){loadUsers();}else{showError('Erreur suppression');}
      }catch(err){showError('Erreur réseau');}
    }
    function logout(){
      sessionStorage.removeItem('userInfo');
      window.location.href='/index.html';
    }
  </script>
</body>
</html>




