<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administration - NBFO Coopérative</title>
  <style>
    body { font-family:sans-serif; background:#f5f5f5; margin:0; }
    .header { background:#388e3c; color:white; padding:20px; display:flex; justify-content:space-between; }
    .btn-logout { background:#e53935; border:none; padding:10px 20px; border-radius:8px; color:white; cursor:pointer; }
    .container { max-width:1200px; margin:0 auto; padding:20px; }
    table { width:100%; border-collapse:collapse; }
    th,td { padding:10px; border-bottom:1px solid #ccc; }
    .alert { display:none; margin:15px 0; padding:12px; border-radius:8px; }
    .alert-error { background:#ffebee; border:1px solid #ef5350; color:#c62828; }
  </style>
</head>
<body>
  <div id="adminProducteurs" class="tab-content">
  <div class="card">
    <div class="card-header">
      <div class="card-title">Ajouter un producteur</div>
    </div>

    <form id="producerForm" style="margin-top:20px;">
      <div class="form-grid">
        <!-- Nom -->
        <div class="form-group">
          <label for="nomProducteur">Nom du producteur *</label>
          <input type="text" id="nomProducteur" maxlength="100" required>
        </div>

        <!-- Téléphone -->
        <div class="form-group">
          <label for="telProducteur">Téléphone *</label>
          <input type="tel" id="telProducteur" maxlength="20" required>
        </div>

        <!-- Type producteur -->
        <div class="form-group">
          <label for="typeProducteur">Type *</label>
          <select id="typeProducteur" required>
            <option value="agriculteur">Agriculteur</option>
            <option value="éleveur">Éleveur</option>
            <option value="pêcheur">Pêcheur</option>
            <option value="artisan">Artisan</option>
            <option value="alimentaire manufacture">Alimentaire manufacture</option>
            <option value="coopérative">Coopérative</option>
            <option value="individuel">Individuel</option>
            <option value="autre">Autre</option>
          </select>
        </div>

        <!-- Carte membre -->
        <div class="form-group">
          <label for="carteMembre">Carte membre</label>
          <input type="checkbox" id="carteMembre">
        </div>

        <!-- Points fidélité -->
        <div class="form-group">
          <label for="pointsFidelite">Points fidélité</label>
          <input type="number" id="pointsFidelite" min="0" step="1" value="0">
        </div>

        <!-- Solde -->
        <div class="form-group">
          <label for="solde">Solde initial</label>
          <input type="number" id="solde" min="0" step="0.01" value="0">
        </div>

        <!-- Statut -->
        <div class="form-group">
          <label for="statut">Statut</label>
          <select id="statut">
            <option value="en_attente" selected>En attente</option>
            <option value="actif">Actif</option>
            <option value="suspendu">Suspendu</option>
          </select>
        </div>

        <!-- Région -->
        <div class="form-group">
          <label for="region">Région</label>
          <select id="region"></select>
        </div>

        <!-- Département -->
        <div class="form-group">
          <label for="departement">Département</label>
          <select id="departement"></select>
        </div>

        <!-- Arrondissement -->
        <div class="form-group">
          <label for="arrondissement">Arrondissement</label>
          <select id="arrondissement"></select>
        </div>

        <!-- Localité -->
        <div class="form-group">
          <label for="localite">Localité</label>
          <input type="text" id="localite" maxlength="100">
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-success">✅ Ajouter producteur</button>
      </div>
    </form>
  </div>
</div>

<script src="/js/auth.js"></script>
<script>   
  // Ce code reste tel quel - il ne touche PAS aux mots de passe
  function getCurrentUser() {
  const userInfo = sessionStorage.getItem("userInfo");
  return userInfo ? JSON.parse(userInfo) : null;
}

function requireLogin() {
  const user = getCurrentUser();
  if (!user || !user.username || !user.role) {
    sessionStorage.clear();
    window.location.href = "/index.html";
    return null;
  }
  return user;
}

/*function loadRoleContent(role) {
  
  
}*/

  // Charger régions/départements/arrondissements dynamiquement
async function loadGeo() {
  try {
    const regionsResp = await fetch('/api/regions');
    const regions = await regionsResp.json();
    document.getElementById('region').innerHTML =
      regions.map(r => `<option value="${r.id}">${r.nom}</option>`).join('');

    document.getElementById('region').addEventListener('change', async (e) => {
      const depResp = await fetch(`/api/departements?region_id=${e.target.value}`);
      const deps = await depResp.json();
      document.getElementById('departement').innerHTML =
        deps.map(d => `<option value="${d.id}">${d.nom}</option>`).join('');
    });

    document.getElementById('departement').addEventListener('change', async (e) => {
      const arrResp = await fetch(`/api/arrondissements?departement_id=${e.target.value}`);
      const arrs = await arrResp.json();
      document.getElementById('arrondissement').innerHTML =
        arrs.map(a => `<option value="${a.id}">${a.nom}</option>`).join('');
    });
  } catch (err) {
    console.error("Erreur chargement géo", err);
  }
}

// Soumission du formulaire
document.getElementById('producerForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const payload = {
    nom_producteur: document.getElementById('nomProducteur').value,
    tel_producteur: document.getElementById('telProducteur').value,
    type_producteur: document.getElementById('typeProducteur').value,
    carte_membre: document.getElementById('carteMembre').checked,
    points_fidelite: parseInt(document.getElementById('pointsFidelite').value),
    solde: parseFloat(document.getElementById('solde').value),
    statut: document.getElementById('statut').value,
    region_id: document.getElementById('region').value || null,
    departement_id: document.getElementById('departement').value || null,
    arrondissement_id: document.getElementById('arrondissement').value || null,
    localite: document.getElementById('localite').value
  };

  try {
    const response = await fetch('/api/producteurs', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!response.ok) throw new Error("Erreur API producteurs");

    alert("Producteur ajouté ✅");
    document.getElementById('producerForm').reset();
  } catch (err) {
    console.error(err);
    alert("Impossible d’ajouter le producteur ❌");
  }
});

// Charger géo au démarrage
loadGeo();

</script>
  <script defer>
    const alertBox=document.getElementById('alertBox');
    const usersContainer=document.getElementById('usersContainer');
          let currentUser=null;

    function showError(msg){
      alertBox.textContent=msg;
      alertBox.style.display='block';
    }

    try{
      const userInfo=sessionStorage.getItem('userInfo');
      if(!userInfo) window.location.href='/index.html';
      currentUser=JSON.parse(userInfo);
      if(currentUser.role!=='admin'){
        showError('Accès refusé : réservé aux administrateurs');
        setTimeout(()=>window.location.href='/dashboard.html',2000);
      }
    }catch(err){
      showError('Session invalide, reconnectez-vous.');
      setTimeout(()=>window.location.href='/index.html',2000);
    }
    async function loadUsers(){
      try{
        const res=await fetch('/users');
        if(!res.ok) throw new Error();
        const users=await res.json();
        if(users.length===0){usersContainer.textContent='Aucun utilisateur';return;}
        usersContainer.innerHTML=`<table>
          <thead><tr><th>Nom</th><th>Rôle</th><th>Actions</th></tr></thead>
          <tbody>${users.map(u=>`
            <tr>
              <td>${u.username}</td>
              <td>${u.role}</td>
              <td>
                <button onclick="editUser('${u.id}')">Modifier</button>
                <button onclick="deleteUser('${u.id}')">Supprimer</button>
              </td>
            </tr>`).join('')}
          </tbody></table>`;
      }catch(err){
        usersContainer.textContent='Erreur de chargement';
      }
    }
    loadUsers();
    async function editUser(id){
      const newRole=prompt('Nouveau rôle pour cet utilisateur (admin, caisse, stock)');
      if(!newRole) return;
      try{
        const res=await fetch(`/users/${id}`,{
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({role:newRole})
        });
        if(res.ok){loadUsers();}else{showError('Erreur modification');}
      }catch(err){showError('Erreur réseau');}
    }

    async function deleteUser(id){
      if(!confirm('Supprimer cet utilisateur ?')) return;
      try{
        const res=await fetch(`/users/${id}`,{method:'DELETE'});
        if(res.ok){loadUsers();}else{showError('Erreur suppression');}
      }catch(err){showError('Erreur réseau');}
    }
    function logout(){
      sessionStorage.removeItem('userInfo');
      window.location.href='/index.html';
    }
  </script>
</body>
</html>



