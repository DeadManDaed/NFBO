<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administration - NBFO Coop√©rative</title>
  <style>
    body { font-family:sans-serif; background:#f5f5f5; margin:0; }
    .header { background:#388e3c; color:white; padding:20px; display:flex; justify-content:space-between; }
    .btn-logout { background:#e53935; border:none; padding:10px 20px; border-radius:8px; color:white; cursor:pointer; }
    .container { max-width:1200px; margin:0 auto; padding:20px; }
    table { width:100%; border-collapse:collapse; }
    th,td { padding:10px; border-bottom:1px solid #ccc; }
    .alert { display:none; margin:15px 0; padding:12px; border-radius:8px; }
    .alert-error { background:#ffebee; border:1px solid #ef5350; color:#c62828; }
  </style>
</head>
<body>
  <div class="header">
    <div>üë®‚Äçüíº Administration</div>
    <button class="btn-logout" onclick="logout()">D√©connexion</button>
  </div>
  <div class="container">
    <div id="alertBox" class="alert alert-error"></div>
    <h2>Gestion des utilisateurs</h2>
    <div id="usersContainer">Chargement...</div>
  </div>

  <script defer>
    const alertBox=document.getElementById('alertBox');
    const usersContainer=document.getElementById('usersContainer');
          let currentUser=null;

    function showError(msg){
      alertBox.textContent=msg;
      alertBox.style.display='block';
    }

    try{
      const userInfo=sessionStorage.getItem('userInfo');
      if(!userInfo) window.location.href='/index.html';
      currentUser=JSON.parse(userInfo);
      if(currentUser.role!=='admin'){
        showError('Acc√®s refus√© : r√©serv√© aux administrateurs');
        setTimeout(()=>window.location.href='/dashboard.html',2000);
      }
    }catch(err){
      showError('Session invalide, reconnectez-vous.');
      setTimeout(()=>window.location.href='/index.html',2000);
    }
    async function loadUsers(){
      try{
        const res=await fetch('/users');
        if(!res.ok) throw new Error();
        const users=await res.json();
        if(users.length===0){usersContainer.textContent='Aucun utilisateur';return;}
        usersContainer.innerHTML=`<table>
          <thead><tr><th>Nom</th><th>R√¥le</th><th>Actions</th></tr></thead>
          <tbody>${users.map(u=>`
            <tr>
              <td>${u.username}</td>
              <td>${u.role}</td>
              <td>
                <button onclick="editUser('${u.id}')">Modifier</button>
                <button onclick="deleteUser('${u.id}')">Supprimer</button>
              </td>
            </tr>`).join('')}
          </tbody></table>`;
      }catch(err){
        usersContainer.textContent='Erreur de chargement';
      }
    }
    loadUsers();
    async function editUser(id){
      const newRole=prompt('Nouveau r√¥le pour cet utilisateur (admin, caisse, stock)');
      if(!newRole) return;
      try{
        const res=await fetch(`/users/${id}`,{
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({role:newRole})
        });
        if(res.ok){loadUsers();}else{showError('Erreur modification');}
      }catch(err){showError('Erreur r√©seau');}
    }

    async function deleteUser(id){
      if(!confirm('Supprimer cet utilisateur ?')) return;
      try{
        const res=await fetch(`/users/${id}`,{method:'DELETE'});
        if(res.ok){loadUsers();}else{showError('Erreur suppression');}
      }catch(err){showError('Erreur r√©seau');}
    }
    function logout(){
      sessionStorage.removeItem('userInfo');
      window.location.href='/index.html';
    }
  </script>
</body>
</html>

